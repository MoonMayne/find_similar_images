<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Similar Images</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; background: #f6f7fb; color: #1f2933; }
    h1 { margin-bottom: 8px; }
    section { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    label { display: block; margin: 8px 0 4px; font-weight: 600; }
    textarea, input, button { width: 100%; box-sizing: border-box; padding: 8px; border-radius: 6px; border: 1px solid #d1d5db; }
    button { cursor: pointer; background: #2563eb; color: white; border: none; font-weight: 600; }
    button.secondary { background: #6b7280; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .group { border: 1px solid #e5e7eb; padding: 12px; border-radius: 6px; margin-bottom: 10px; background: #fdfefe; }
    .files { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 12px; align-items: start; }
    .file { background: #eef2ff; color: #1e3a8a; padding: 4px 6px; border-radius: 4px; font-size: 12px; flex: 1; }
    .file-row { display: flex; align-items: flex-start; gap: 12px; min-height: 240px; }
    .stats { font-size: 12px; color: #4b5563; }
    .badge { display: inline-block; padding: 2px 6px; border-radius: 999px; background: #22c55e; color: #0b2e17; font-size: 12px; margin-left: 6px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .flex { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .small { font-size: 12px; color: #6b7280; }
    .thumb { max-width: 420px; max-height: 420px; display: none; border-radius: 6px; border: 1px solid #e5e7eb; object-fit: contain; background: #fff; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal.open { display: flex; }
    .modal-content { position: relative; max-width: 90vw; max-height: 90vh; }
    .modal img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 6px; background: #111; }
    .modal .nav { position: absolute; top: 50%; transform: translateY(-50%); color: #fff; font-size: 32px; cursor: pointer; padding: 12px; user-select: none; }
    .modal .prev { left: -48px; }
    .modal .next { right: -48px; }
    .modal .close { position: absolute; top: -40px; right: 0; color: #fff; font-size: 20px; cursor: pointer; padding: 8px; }
  </style>
</head>
<body>
  <h1>Find Similar Images</h1>
  <p class="small">Use this minimal UI to kick off scans, review groups, and trash duplicates. Endpoints are served by the FastAPI backend.</p>

  <section>
    <h2>Scan</h2>
    <label for="directories">Directories (one per line)</label>
    <textarea id="directories" rows="3" placeholder="/path/to/photos&#10;/path/to/backup"></textarea>
    <div class="row">
      <div>
        <label for="primary">Primary directory (optional)</label>
        <input id="primary" type="text" placeholder="/path/to/primary" />
      </div>
      <div>
        <label for="threshold">Similarity threshold (max distance, default 0)</label>
        <input id="threshold" type="number" value="0" min="0" max="64" />
      </div>
      <div>
        <label for="workers">Workers (threads, optional)</label>
        <input id="workers" type="number" min="1" placeholder="e.g. 4" />
      </div>
      <div>
        <label for="hashdb">Hash cache path (optional)</label>
        <input id="hashdb" type="text" placeholder="data/hash_cache.json" />
      </div>
    </div>
    <button id="startScan">Start Scan</button>
    <p class="small" id="scanStatus"></p>
  </section>

  <section>
    <h2>Groups</h2>
    <div class="row">
      <div>
        <label for="jobId">Job ID</label>
        <input id="jobId" type="text" placeholder="Returned from scan" />
      </div>
      <div>
        <label for="primaryActions">Primary directory for actions</label>
        <input id="primaryActions" type="text" placeholder="/path/to/primary" />
      </div>
      <div>
        <label for="trashDest">Trash directory override (optional)</label>
        <input id="trashDest" type="text" placeholder="Leave blank for system trash" />
      </div>
    </div>
    <div class="actions">
      <button id="refreshGroups" class="secondary">Load Groups</button>
      <button id="loadAllPreviews" class="secondary">Load All Previews</button>
      <button id="trashNonPrimary" class="secondary">Trash Non-Primary</button>
      <button id="trashAll" class="secondary">Trash All Duplicates</button>
    </div>
    <div class="actions" style="gap:12px;">
      <label style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="primaryFirst" />
        Primary-first (keep primary dir file when trashing all)
      </label>
      <label style="display:flex;align-items:center;gap:6px;">
        Page size: <input type="number" id="pageSize" value="50" min="1" max="500" style="width:90px;" />
      </label>
      <div id="pager" class="small"></div>
    </div>
    <div id="progressBar" style="width:100%;height:10px;background:#e5e7eb;border-radius:6px;overflow:hidden;display:none;margin:8px 0 4px;">
      <div id="progressFill" style="height:100%;width:0;background:#2563eb;"></div>
    </div>
    <div id="progressText" class="small"></div>
    <div id="groups"></div>
  </section>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close" id="modalClose">✕</span>
      <span class="nav prev" id="modalPrev">‹</span>
      <span class="nav next" id="modalNext">›</span>
      <img id="modalImg" alt="Preview"/>
      <div class="small" id="modalMeta" style="color:#e5e7eb;margin-top:6px;"></div>
    </div>
  </div>

  <script>
    const API_BASE = window.API_BASE || 'http://localhost:8000';
    let currentGroups = [];
    let currentJobId = null;
    let autoLoadedForJob = null;
    let modalState = { groupIndex: 0, fileIndex: 0, images: [] };
    let pagination = { offset: 0, limit: 50, total: 0 };
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const statusEl = document.getElementById('scanStatus');
    const groupsEl = document.getElementById('groups');
    const trashAllBtn = document.getElementById('trashAll');
    const trashNonPrimaryBtn = document.getElementById('trashNonPrimary');
    const refreshGroupsBtn = document.getElementById('refreshGroups');
    const loadAllPreviewsBtn = document.getElementById('loadAllPreviews');
    const primaryFirstChk = document.getElementById('primaryFirst');
    const pageSizeInput = document.getElementById('pageSize');
    const pagerEl = document.getElementById('pager');
    const modalEl = document.getElementById('modal');
    const modalImg = document.getElementById('modalImg');
    const modalMeta = document.getElementById('modalMeta');
    const modalPrev = document.getElementById('modalPrev');
    const modalNext = document.getElementById('modalNext');
    const modalClose = document.getElementById('modalClose');

    async function startScan() {
      const dirs = document.getElementById('directories').value.split('\n').map(d => d.trim()).filter(Boolean);
      if (!dirs.length) {
        alert('Provide at least one directory');
        return;
      }
      const payload = {
        directories: dirs,
        primary_dir: document.getElementById('primary').value || null,
        threshold: Number(document.getElementById('threshold').value || 0),
        workers: document.getElementById('workers').value ? Number(document.getElementById('workers').value) : null,
        hash_db: document.getElementById('hashdb').value || null,
      };
      statusEl.textContent = 'Starting scan...';
      progressBar.style.display = 'block';
      progressFill.style.width = '0%';
      progressText.textContent = 'Pending...';
      const res = await fetch(`${API_BASE}/api/scan`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const data = await res.json();
      document.getElementById('jobId').value = data.job_id;
      currentJobId = data.job_id;
      currentGroups = [];
      setActionState(false);
      statusEl.textContent = `Job ${data.job_id} created. Polling status...`;
      pollStatus(data.job_id);
    }

    async function pollStatus(jobId) {
      const res = await fetch(`${API_BASE}/api/scan/${jobId}`);
      if (!res.ok) return;
      const data = await res.json();
      statusEl.textContent = `Status: ${data.status}. Groups: ${data.groups}`;
      if (data.status === 'running' || data.status === 'pending') {
        progressBar.style.display = 'block';
        progressFill.style.width = '50%';
        progressText.textContent = `${data.status}...`;
      }
      if (data.status === 'running' || data.status === 'pending') {
        setTimeout(() => pollStatus(jobId), 2000);
      } else if (data.status === 'succeeded') {
        progressBar.style.display = 'block';
        progressFill.style.width = '100%';
        progressText.textContent = `Completed. Groups: ${data.groups}`;
        if (autoLoadedForJob !== jobId) {
          await loadGroups(0);
          autoLoadedForJob = jobId;
        }
      } else if (data.status === 'failed') {
        progressBar.style.display = 'block';
        progressFill.style.width = '100%';
        progressFill.style.background = '#dc2626';
        progressText.textContent = `Failed: ${data.message || ''}`;
      }
    }

    async function loadGroups(offsetOverride = null) {
      const jobId = document.getElementById('jobId').value.trim() || currentJobId;
      if (!jobId) {
        alert('Enter job id');
        return;
      }
      currentJobId = jobId;
      const pageSize = Number(pageSizeInput.value || 50);
      const offset = offsetOverride !== null ? offsetOverride : pagination.offset;
      const res = await fetch(`${API_BASE}/api/groups?job_id=${encodeURIComponent(jobId)}&limit=${pageSize}&offset=${offset}`);
      const data = await res.json();
      currentGroups = data.groups;
      pagination = { offset, limit: pageSize, total: data.total_groups };
      renderGroups(data.groups, document.getElementById('primaryActions').value.trim(), document.getElementById('trashDest').value.trim());
      renderPager();
      setActionState(currentGroups.length > 0);
    }

    function renderGroups(groups, primaryDir, trashDest) {
      groupsEl.innerHTML = '';
      groups.forEach(group => {
        const div = document.createElement('div');
        div.className = 'group';
        div.dataset.groupId = group.id;
        const filesHtml = group.files.map(f => {
          const stats = group.stats[f] || {};
          const meta = `(${stats.width || 0}x${stats.height || 0}, exif ${stats.exif_count || 0})`;
          const keeper = group.suggested === f ? '<span class="badge">Suggested</span>' : '';
          const checked = group.suggested === f ? 'checked' : '';
          return `
            <div class="file-row" data-path="${f}">
              <label style="display:flex;align-items:center;gap:8px;font-size:13px;flex:1;">
                <input type="radio" name="keeper-${group.id}" value="${f}" ${checked}/>
                <span class="file">${f} ${keeper} <span class="stats">${meta}</span></span>
              </label>
              <img class="thumb" data-path="${f}" alt="preview" />
            </div>`;
        }).join('');
        div.innerHTML = `
          <div class="files">${filesHtml}</div>
          <div class="actions">
            <button data-action="load-previews" class="secondary">Load previews</button>
            <button data-action="trash-others">Trash others</button>
            <button data-action="trash-all" class="secondary">Trash all</button>
            <button data-action="open-viewer" class="secondary">Open viewer</button>
          </div>
        `;
        div.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => {
            const keeperInput = div.querySelector(`input[name="keeper-${group.id}"]:checked`);
            const keeper = keeperInput ? keeperInput.value : group.suggested;
            if (btn.dataset.action === 'load-previews') {
              loadPreviews(group, div);
              return;
            }
            if (btn.dataset.action === 'open-viewer') {
              openViewer(group);
              return;
            }
            const victims = btn.dataset.action === 'trash-all'
              ? group.files
              : group.files.filter(f => f !== keeper);
            trashPaths(victims, trashDest);
          });
        });
        groupsEl.appendChild(div);
      });
    }

    async function loadPreviews(group, container) {
      const jobId = currentJobId;
      if (!jobId) return;
      const fileRows = Array.from(container.querySelectorAll('.file-row'));
      fileRows.forEach(row => {
        const path = row.dataset.path;
        const img = row.querySelector('img.thumb');
        if (img.dataset.loaded === '1') return;
        fetch(`${API_BASE}/api/thumbnail?job_id=${encodeURIComponent(jobId)}&path=${encodeURIComponent(path)}&max_size=640`)
          .then(r => r.ok ? r.blob() : Promise.reject(new Error('thumb failed')))
          .then(blob => {
            img.src = URL.createObjectURL(blob);
            img.style.display = 'block';
            img.dataset.loaded = '1';
            img.onclick = () => openViewer(group, path);
          })
          .catch(() => {});
      });
    }

    async function loadAllPreviews() {
      const groups = Array.from(document.querySelectorAll('.group'));
      for (const groupDiv of groups) {
        const gid = groupDiv.dataset.groupId;
        const group = currentGroups.find(g => String(g.id) === String(gid));
        if (group) {
          await loadPreviews(group, groupDiv);
        }
      }
    }

    function openViewer(group, startPath = null) {
      modalState.images = group.files;
      modalState.groupIndex = currentGroups.findIndex(g => g.id === group.id);
      modalState.fileIndex = startPath ? group.files.findIndex(f => f === startPath) : 0;
      showModalImage();
    }

    async function showModalImage() {
      if (!modalState.images.length) return;
      const path = modalState.images[modalState.fileIndex];
      const jobId = currentJobId;
      try {
        const res = await fetch(`${API_BASE}/api/thumbnail?job_id=${encodeURIComponent(jobId)}&path=${encodeURIComponent(path)}&max_size=1024`);
        if (!res.ok) throw new Error('thumb fail');
        const blob = await res.blob();
        modalImg.src = URL.createObjectURL(blob);
        modalMeta.textContent = path;
        modalEl.classList.add('open');
      } catch {
        modalEl.classList.remove('open');
      }
    }

    function modalPrevImage() {
      if (!modalState.images.length) return;
      modalState.fileIndex = (modalState.fileIndex - 1 + modalState.images.length) % modalState.images.length;
      showModalImage();
    }

    function modalNextImage() {
      if (!modalState.images.length) return;
      modalState.fileIndex = (modalState.fileIndex + 1) % modalState.images.length;
      showModalImage();
    }

    async function trashPaths(paths, destination) {
      if (!paths.length) return;
      const jobId = document.getElementById('jobId').value.trim() || currentJobId;
      const payload = { job_id: jobId, paths, destination: destination || null, recreate_paths: false };
      await fetch(`${API_BASE}/api/actions/trash`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      alert(`Trashed ${paths.length} files`);
    }

    async function trashNonPrimary() {
      const jobId = document.getElementById('jobId').value.trim() || currentJobId;
      const primaryDir = document.getElementById('primaryActions').value.trim();
      const destination = document.getElementById('trashDest').value.trim();
      if (!jobId || !primaryDir) {
        alert('Provide job id and primary directory');
        return;
      }
      const payload = { job_id: jobId, primary_dir: primaryDir, destination: destination || null, recreate_paths: false };
      await fetch(`${API_BASE}/api/actions/trash-non-primary`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      alert('Trashed non-primary files');
    }

    async function trashAll() {
      const jobId = document.getElementById('jobId').value.trim() || currentJobId;
      const destination = document.getElementById('trashDest').value.trim();
      const primaryDir = document.getElementById('primaryActions').value.trim() || null;
      const primaryFirst = primaryFirstChk.checked && primaryDir;
      const victims = [];
      currentGroups.forEach(group => {
        const radio = document.querySelector(`input[name="keeper-${group.id}"]:checked`);
        let keeper = radio ? radio.value : group.suggested;
        if (primaryFirst && group.files.some(f => f.startsWith(primaryDir))) {
          // prefer primary directory file as keeper
          const primaryFile = group.files.find(f => f.startsWith(primaryDir));
          if (primaryFile) keeper = primaryFile;
        }
        victims.push(...group.files.filter(f => f !== keeper));
      });
      await trashPaths(victims, destination);
    }

    function setActionState(enabled) {
      trashAllBtn.disabled = !enabled;
      trashNonPrimaryBtn.disabled = !enabled;
      loadAllPreviewsBtn.disabled = !enabled;
    }

    function renderPager() {
      const totalPages = Math.ceil(pagination.total / pagination.limit) || 1;
      const currentPage = Math.floor(pagination.offset / pagination.limit) + 1;
      pagerEl.textContent = `Page ${currentPage} of ${totalPages} (total groups: ${pagination.total})`;
      pagerEl.onclick = (e) => {
        const target = e.target;
      };
      // Add simple prev/next controls
      pagerEl.innerHTML = `
        <button class="secondary" ${currentPage <= 1 ? 'disabled' : ''} id="prevPage">Prev</button>
        <button class="secondary" ${currentPage >= totalPages ? 'disabled' : ''} id="nextPage">Next</button>
        <span style="margin-left:8px;">Page ${currentPage} of ${totalPages} (total ${pagination.total})</span>
      `;
      const prev = document.getElementById('prevPage');
      const next = document.getElementById('nextPage');
      if (prev) prev.onclick = () => loadGroups(Math.max(0, pagination.offset - pagination.limit));
      if (next) next.onclick = () => loadGroups(pagination.offset + pagination.limit);
    }

    document.getElementById('startScan').onclick = startScan;
    refreshGroupsBtn.onclick = loadGroups;
    loadAllPreviewsBtn.onclick = loadAllPreviews;
    trashNonPrimaryBtn.onclick = trashNonPrimary;
    trashAllBtn.onclick = trashAll;
    setActionState(false);

    modalPrev.onclick = modalPrevImage;
    modalNext.onclick = modalNextImage;
    modalClose.onclick = () => modalEl.classList.remove('open');
    modalEl.onclick = (e) => { if (e.target === modalEl) modalEl.classList.remove('open'); };
  </script>
</body>
</html>
